<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>中间代码 | life</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/life/favicon.ico">
    <meta name="description" content="浅梦辄止，书墨未浓">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/life/assets/css/0.styles.4c80574b.css" as="style"><link rel="preload" href="/life/assets/js/app.818b6a6f.js" as="script"><link rel="preload" href="/life/assets/js/2.99b74951.js" as="script"><link rel="preload" href="/life/assets/js/9.bb0b5782.js" as="script"><link rel="prefetch" href="/life/assets/js/10.e8ef0f53.js"><link rel="prefetch" href="/life/assets/js/11.de6536b2.js"><link rel="prefetch" href="/life/assets/js/12.ea095716.js"><link rel="prefetch" href="/life/assets/js/13.48047ffb.js"><link rel="prefetch" href="/life/assets/js/14.46241e91.js"><link rel="prefetch" href="/life/assets/js/15.ed051df6.js"><link rel="prefetch" href="/life/assets/js/16.7b32ccd1.js"><link rel="prefetch" href="/life/assets/js/17.fa33e5f1.js"><link rel="prefetch" href="/life/assets/js/18.df82ddf5.js"><link rel="prefetch" href="/life/assets/js/19.67c87ff7.js"><link rel="prefetch" href="/life/assets/js/20.b100a442.js"><link rel="prefetch" href="/life/assets/js/21.485ff078.js"><link rel="prefetch" href="/life/assets/js/22.c0353330.js"><link rel="prefetch" href="/life/assets/js/23.2259f17f.js"><link rel="prefetch" href="/life/assets/js/24.036b8f7c.js"><link rel="prefetch" href="/life/assets/js/25.6b1b81c7.js"><link rel="prefetch" href="/life/assets/js/26.67d520ff.js"><link rel="prefetch" href="/life/assets/js/27.4f003263.js"><link rel="prefetch" href="/life/assets/js/28.9a4527db.js"><link rel="prefetch" href="/life/assets/js/29.a3d75b38.js"><link rel="prefetch" href="/life/assets/js/3.604c14e1.js"><link rel="prefetch" href="/life/assets/js/30.6311e7bc.js"><link rel="prefetch" href="/life/assets/js/31.ccb81e51.js"><link rel="prefetch" href="/life/assets/js/32.fe56a522.js"><link rel="prefetch" href="/life/assets/js/33.2abe0a41.js"><link rel="prefetch" href="/life/assets/js/34.cf12d10a.js"><link rel="prefetch" href="/life/assets/js/35.da448397.js"><link rel="prefetch" href="/life/assets/js/36.c17c2195.js"><link rel="prefetch" href="/life/assets/js/37.9f9af7b9.js"><link rel="prefetch" href="/life/assets/js/38.8b5e0c98.js"><link rel="prefetch" href="/life/assets/js/39.c9644dfb.js"><link rel="prefetch" href="/life/assets/js/4.a0d54788.js"><link rel="prefetch" href="/life/assets/js/40.e0749da6.js"><link rel="prefetch" href="/life/assets/js/41.125b5aa6.js"><link rel="prefetch" href="/life/assets/js/42.a93b801c.js"><link rel="prefetch" href="/life/assets/js/43.4ee7b24c.js"><link rel="prefetch" href="/life/assets/js/44.65fd11d6.js"><link rel="prefetch" href="/life/assets/js/45.ec5c1768.js"><link rel="prefetch" href="/life/assets/js/46.68821edd.js"><link rel="prefetch" href="/life/assets/js/5.61d3ac18.js"><link rel="prefetch" href="/life/assets/js/6.aa8b62e8.js"><link rel="prefetch" href="/life/assets/js/7.96d1830c.js"><link rel="prefetch" href="/life/assets/js/8.386a89c8.js">
    <link rel="stylesheet" href="/life/assets/css/0.styles.4c80574b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/life/" class="home-link router-link-active"><!----> <span class="site-name">life</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/life/project/" class="nav-link router-link-active">
  工程
</a></div><div class="nav-item"><a href="/life/science/" class="nav-link">
  科学
</a></div><div class="nav-item"><a href="/life/practice/" class="nav-link">
  修行
</a></div><div class="nav-item"><a href="/life/inherit/" class="nav-link">
  传承
</a></div><div class="nav-item"><a href="https://github.com/zhangxishuo" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/life/project/" class="nav-link router-link-active">
  工程
</a></div><div class="nav-item"><a href="/life/science/" class="nav-link">
  科学
</a></div><div class="nav-item"><a href="/life/practice/" class="nav-link">
  修行
</a></div><div class="nav-item"><a href="/life/inherit/" class="nav-link">
  传承
</a></div><div class="nav-item"><a href="https://github.com/zhangxishuo" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/life/project/spring-boot/" class="sidebar-heading clickable"><span>Spring Boot</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/life/project/spring-boot/01.prepare.html" class="sidebar-link">准备工作</a></li><li><a href="/life/project/spring-boot/02.hello-world.html" class="sidebar-link">Hello World</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/life/project/compile/" class="sidebar-heading clickable router-link-active open"><span>编译原理</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/life/project/compile/01.lexical-analysis.html" class="sidebar-link">词法分析</a></li><li><a href="/life/project/compile/02.syntactic-analysis.html" class="sidebar-link">语法分析</a></li><li><a href="/life/project/compile/03.semantic-analysis.html" class="sidebar-link">语义分析</a></li><li><a href="/life/project/compile/04.runtime.html" class="sidebar-link">运行时机制</a></li><li><a href="/life/project/compile/05.intermediate-representation.html" aria-current="page" class="active sidebar-link">中间代码</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/life/project/compile/05.intermediate-representation.html#ir-的用途和层次" class="sidebar-link">IR 的用途和层次</a></li><li class="sidebar-sub-header"><a href="/life/project/compile/05.intermediate-representation.html#ir-的数据结构" class="sidebar-link">IR 的数据结构</a></li><li class="sidebar-sub-header"><a href="/life/project/compile/05.intermediate-representation.html#ssa-格式的-ir" class="sidebar-link">SSA 格式的 IR</a></li></ul></li><li><a href="/life/project/compile/06.optimization.html" class="sidebar-link">代码优化</a></li><li><a href="/life/project/compile/07.generation.html" class="sidebar-link">代码生成</a></li><li><a href="/life/project/compile/08.java-compiler-1.html" class="sidebar-link">走近 Java 编译器(一)</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/life/project/jvm" class="sidebar-heading clickable"><span>深入拆解 Java 虚拟机</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/life/project/jvm/01.basic-type.html" class="sidebar-link">Java 的基本类型</a></li><li><a href="/life/project/jvm/02.class-load.html" class="sidebar-link">Java 类加载</a></li><li><a href="/life/project/jvm/03.method-call-1.html" class="sidebar-link">JVM 如何执行方法调用(一)</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="中间代码"><a href="#中间代码" class="header-anchor">#</a> 中间代码</h1> <p><code>IR</code>，也就是中间代码<code>Intermediate Representation</code>，有时也称<code>Intermediate Code</code>，它是编译器中很重要的一种数据结构。编译器在做完前端工作以后，首先就是生成<code>IR</code>，并在此基础上执行各种优化算法，最后再生成目标代码。</p> <h2 id="ir-的用途和层次"><a href="#ir-的用途和层次" class="header-anchor">#</a> IR 的用途和层次</h2> <p>设计<code>IR</code>的用途：</p> <ul><li>分析和变换</li> <li>直接解释执行</li></ul> <p>编译器中，基于<code>IR</code>的分析和处理工作，一开始可以基于一些抽象层次比较高的语义，这时所需要的<code>IR</code>更接近源代码。而在后面，则会使用低层次的、更加接近目标代码的语义。</p> <p>基于这种从高到低的抽象层次，<code>IR</code>可以归结为<code>HIR</code>、<code>MIR</code>和<code>LIR</code>三类。</p> <h3 id="hir-基于源语言做一些分析和变换"><a href="#hir-基于源语言做一些分析和变换" class="header-anchor">#</a> HIR：基于源语言做一些分析和变换</h3> <p><code>High IR</code>，能够准确表达源语言的语义。</p> <p><code>AST</code>和符号表也可以准确表达源语言的语义，<code>AST</code>也可以算作一种<code>IR</code>。</p> <p>基于<code>HIR</code>，可以做一些高层次的代码优化，比如常数折叠、内联等。在<code>Java</code>和<code>Go</code>的编译器中，你可以看到不少基于<code>AST</code>做的优化工作。</p> <h3 id="mir-独立于源语言和-cpu-架构做分析和优化"><a href="#mir-独立于源语言和-cpu-架构做分析和优化" class="header-anchor">#</a> MIR：独立于源语言和 CPU 架构做分析和优化</h3> <p>大量的优化算法是可以通用的，没有必要依赖源语言的语法和语义，也没有必要依赖具体的<code>CPU</code>架构。</p> <p>这些优化包括部分算术优化、常量和变量传播、死代码删除等。实现这类分析和优化功能的<code>IR</code>称为<code>Middle IR</code>。</p> <p>因为<code>MIR</code>跟源代码和目标代码都无关，所以在讲解优化算法时，通常是基于<code>MIR</code>，如三地址代码<code>Three Address Code，TAC</code>。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">)</span>
        b <span class="token operator">=</span> a<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        b <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>以上代码对应的<code>TAC</code>是：</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>BB1:
    b := 0
    if a &gt; 10 goto BB3
BB2:
    b := 10
    goto BB4
BB3:
    b := a
BB4:
    return b
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><code>TAC</code>用<code>goto</code>语句取代了<code>if</code>语句、循环语句这种比较高级的语句，当然也不会有类、继承这些高层的语言结构。但是，它又没有涉及数据如何在内存读写等细节，书写格式也不像汇编代码，与具体的目标代码也是独立的。</p> <h3 id="lir-依赖于-cpu-架构做优化和代码生成"><a href="#lir-依赖于-cpu-架构做优化和代码生成" class="header-anchor">#</a> LIR：依赖于 CPU 架构做优化和代码生成</h3> <p><code>Low IR</code>，其指令通常可以与机器指令一一对应，比较容易翻译成机器指令或汇编代码。<code>LIR</code>体现了<code>CPU</code>架构的底层特征，因此可以做一些<code>CPU</code>架构相关的优化。</p> <p><img src="/life/assets/img/00.d9ebaec4.jpg" alt="LIR"></p> <p>这是<code>Java</code>的<code>JIT</code>编译器输出的<code>LIR</code>信息，里面的指令名称已经跟汇编代码很像了，并且会直接使用<code>AMD64</code>架构的寄存器名称。</p> <h3 id="p-code-用于解释执行的-ir"><a href="#p-code-用于解释执行的-ir" class="header-anchor">#</a> P-code：用于解释执行的 IR</h3> <p><code>Portable Code</code>，与具体机器无关，因此可以很容易地运行在多种电脑上。这类<code>IR</code>对编译器来说，就是做编译的目标代码。<code>Java</code>的字节码就是<code>P-code</code>。除此之外，<code>Python</code>、<code>Erlang</code>也有自己的字节码，<code>.NET</code>平台、<code>Visual Basic</code>程序也不例外。</p> <p>其实，完全可以基于<code>AST</code>实现一个全功能的解释器，只不过性能会差一些。对于专门用来解释执行的<code>IR</code>，通常会有一些特别的设计，跟虚拟机配合来尽量提升运行速度。</p> <p><code>P-code</code>也可能被进一步编译，形成可以直接执行的机器码。<code>Java</code>的字节码就是这样的例子。</p> <h2 id="ir-的数据结构"><a href="#ir-的数据结构" class="header-anchor">#</a> IR 的数据结构</h2> <p><code>IR</code>并不像源代码和汇编代码那样有特定的书写格式，只是编译过程中的一个数据结构而已。</p> <p>在实际的实现中，有线性结构、树结构、有向无环图<code>DAG</code>、程序依赖图<code>PDG</code>等多种格式。要根据具体要处理的工作的特点，来选择合适的数据结构。</p> <h3 id="第一种-类似-tac-的线性结构-linear-form"><a href="#第一种-类似-tac-的线性结构-linear-form" class="header-anchor">#</a> 第一种：类似 TAC 的线性结构（Linear Form）</h3> <p>你可以把代码表示成一行行的指令或语句，用数组或者列表保存就行了。其中的符号，需要引用符号表，来提供类型等信息。</p> <p>这种线性结构有时候也被称作<code>goto</code>格式。因为高级语言里的条件语句、循环语句，要变成用<code>goto</code>语句跳转的方式。</p> <h3 id="第二种-树结构"><a href="#第二种-树结构" class="header-anchor">#</a> 第二种：树结构</h3> <p>树结构可以用作<code>IR</code>，<code>AST</code>就是一种树结构。树结构的缺点是，可能有冗余的子树。</p> <p><img src="/life/assets/img/01.74e6c6d6.jpg" alt="树结构"></p> <p>语句<code>a = 5; b = (2 + a) + a * 3;</code>形成的<code>AST</code>，如果基于这个树结构生成代码，可能会做两次从内存中读取<code>a</code>的值的操作，并存到两个临时变量中。</p> <h3 id="第三种-有向无环图-directed-acyclic-graph-dag"><a href="#第三种-有向无环图-directed-acyclic-graph-dag" class="header-anchor">#</a> 第三种：有向无环图（Directed Acyclic Graph，DAG）</h3> <p><code>DAG</code>结构，是在树结构的基础上，消除了冗余的子树。转化成<code>DAG</code>以后，对<code>a</code>的内存访问只做一次就行了。</p> <p><img src="/life/assets/img/02.168f1617.jpg" alt="DAG"></p> <h3 id="第四种-程序依赖图-program-dependence-graph-pdg"><a href="#第四种-程序依赖图-program-dependence-graph-pdg" class="header-anchor">#</a> 第四种：程序依赖图（Program Dependence Graph，PDG）</h3> <p>程序依赖图，是显式地把程序中的数据依赖和控制依赖表示出来，形成一个图状的数据结构。基于这个数据结构，我们再做一些优化算法的时候，会更容易实现。</p> <p>所以现在，有很多编译器在运行优化算法的时候，都基于类似<code>PDG</code>的数据结构，比如我在课程后面会分析的<code>Java</code>的<code>JIT</code>编译器和<code>JavaScript</code>的编译器。</p> <h2 id="ssa-格式的-ir"><a href="#ssa-格式的-ir" class="header-anchor">#</a> SSA 格式的 IR</h2> <p><code>SSA</code>是<code>Static Single Assignment</code>的缩写，也就是静态单赋值。这是<code>IR</code>的一种设计范式，它要求一个变量只能被赋值一次。</p> <p><code>y = x1 + x2 + x3 + x4</code>的普通<code>TAC</code>如下：</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>y := x1 + x2;
y := y + x3;
y := y + x4;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>其中，<code>y</code>被赋值了三次，改写成<code>SSA</code>的形式：</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>t1 := x1 + x2;
t2 := t1 + x3;
y  := t2 + x4;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>为什么要费力写成这种形式呢，还要为此多添加<code>t1</code>和<code>t2</code>两个临时变量？</p> <p>原因是，使用<code>SSA</code>的形式，体现了精确的<strong>使用 - 定义</strong><code>Use-def</code>关系。并且由于变量的值定义出来以后就不再变化，使得基于<code>SSA</code>更容易运行一些优化算法。</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">int</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">)</span>
        b <span class="token operator">=</span> a<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        b <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>对于同样的示例代码，对应的<code>SSA</code>格式如下：</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>BB1:
    b1 := 0
    if a &gt; 10 goto BB3
BB2:
    b2 := 10
    goto BB4
BB3:
    b3 := a
BB4:
    b4 := phi(BB2, BB3, b2, b3)
    return b4
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><code>phi</code>指令，会根据控制流的实际情况确定<code>b4</code>的值。如果<code>BB4</code>的前序节点是<code>BB2</code>，那么<code>b4</code>的取值是<code>b2</code>；而如果<code>BB4</code>的前序节点是<code>BB3</code>，那么<code>b4</code>的取值就是<code>b3</code>。</p> <p>如果要满足<code>SSA</code>的要求，那么在遇到有程序分支的情况下，就必须引入<code>phi</code>指令。</p> <p><strong>由于 SSA 格式的优点，现代语言用于优化的 IR，很多都是基于 SSA 的了，包括我们本课程涉及的 Java 的 JIT 编译器、JavaScript 的 V8 编译器、Go 语言的 gc 编译器、Julia 编译器，以及 LLVM 工具等。</strong></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/life/project/compile/04.runtime.html" class="prev">
        运行时机制
      </a></span> <span class="next"><a href="/life/project/compile/06.optimization.html">
        代码优化
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/life/assets/js/app.818b6a6f.js" defer></script><script src="/life/assets/js/2.99b74951.js" defer></script><script src="/life/assets/js/9.bb0b5782.js" defer></script>
  </body>
</html>
